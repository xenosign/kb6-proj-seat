<!DOCTYPE html>
<html lang="kr">
  <head>
    <meta charset="UTF-8" />
    <title>좌석 예매 시스템</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
      .section-title {
        font-weight: bold;
        margin-top: 20px;
        font-size: 18px;
      }

      .seat-row {
        display: flex;
        align-items: center;
        margin-bottom: 6px;
      }

      .row-label {
        width: 40px;
        font-weight: bold;
      }

      .seat {
        width: 24px;
        height: 24px;
        margin: 2px;
        display: inline-block;
        text-align: center;
        line-height: 24px;
        border-radius: 4px;
        cursor: pointer;
      }

      .available {
        background-color: lightgray;
      }
      .reserved {
        background-color: tomato;
        color: white;
      }
      .pending {
        background-color: dodgerblue;
        color: white;
      }

      #modal {
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -30%);
        background: white;
        padding: 20px;
        border: 2px solid #444;
        border-radius: 8px;
        display: none;
        z-index: 9999;
      }

      #modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        z-index: 9998;
      }

      #timer {
        font-weight: bold;
        margin-top: 10px;
        color: red;
      }

      /* 정보 모달 스타일 */
      #info-modal {
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -30%);
        background: white;
        padding: 20px;
        border: 2px solid #444;
        border-radius: 8px;
        display: none;
        z-index: 9999;
      }

      #info-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        z-index: 9998;
      }
    </style>
  </head>
  <body>
    <h2>좌석 현황</h2>
    <div id="seat-container"></div>

    <!-- 예약 확인 모달 (AVAILABLE 좌석용) -->
    <div id="modal-overlay"></div>
    <div id="modal">
      <p id="modal-text">좌석을 예약하시겠습니까?</p>
      <div id="timer">20</div>
      <button onclick="confirmReservation()">확인</button>
      <button onclick="closeModal()">취소</button>
    </div>

    <!-- 상태 정보 모달 (PENDING/RESERVED 좌석용) -->
    <div id="info-modal-overlay"></div>
    <div id="info-modal">
      <p id="info-modal-text"></p>
      <button onclick="closeInfoModal()">확인</button>
    </div>

    <script>
      const seatMap = new Map(); // seatId -> seat
      const groupedSeats = {}; // section -> row -> seat[]
      let selectedSeatId = null;
      let countdown = 20;
      let countdownInterval = null;
      let confirmed = false;
      let modalHandled = false;

      const container = document.getElementById('seat-container');

      fetch('http://localhost:8080/seat/all')
        .then((res) => res.json())
        .then((data) => {
          data.forEach((seat) => {
            seatMap.set(seat.seatId, seat);
            const section = seat.section;
            const row = seat.seatRow;

            if (!groupedSeats[section]) groupedSeats[section] = {};
            if (!groupedSeats[section][row]) groupedSeats[section][row] = [];

            groupedSeats[section][row].push(seat);
          });

          renderGroupedSeats(groupedSeats);
        });

      function renderGroupedSeats(grouped) {
        Object.keys(grouped).forEach((section) => {
          const sectionDiv = document.createElement('div');
          const sectionTitle = document.createElement('div');
          sectionTitle.className = 'section-title';
          sectionTitle.innerText = `구역 ${section}`;
          sectionDiv.appendChild(sectionTitle);

          const rows = grouped[section];
          Object.keys(rows)
            .sort((a, b) => a - b)
            .forEach((row) => {
              const rowDiv = document.createElement('div');
              rowDiv.className = 'seat-row';

              const rowLabel = document.createElement('div');
              rowLabel.className = 'row-label';
              rowLabel.innerText = `${row}열`;
              rowDiv.appendChild(rowLabel);

              const seatsInRow = rows[row].sort(
                (a, b) => a.seatNumber - b.seatNumber
              );
              seatsInRow.forEach((seat) => {
                const seatDiv = document.createElement('div');
                seatDiv.classList.add('seat');
                if (seat.status === 'RESERVED') {
                  seatDiv.classList.add('reserved');
                } else if (seat.status === 'PENDING') {
                  seatDiv.classList.add('pending');
                } else {
                  seatDiv.classList.add('available');
                }
                // 모든 좌석에 클릭 이벤트 추가
                seatDiv.onclick = () => selectSeat(seat.seatId);
                seatDiv.id = 'seat-' + seat.seatId;
                seatDiv.innerText = seat.seatNumber;
                seatDiv.title = `${seat.section}-${seat.seatRow}-${seat.seatNumber}`;
                rowDiv.appendChild(seatDiv);
              });

              sectionDiv.appendChild(rowDiv);
            });

          container.appendChild(sectionDiv);
        });
      }

      function updateSeat(seat) {
        seatMap.set(seat.seatId, seat);
        const div = document.getElementById('seat-' + seat.seatId);
        if (div) {
          div.className = 'seat';
          if (seat.status === 'RESERVED') {
            div.classList.add('reserved');
          } else if (seat.status === 'PENDING') {
            div.classList.add('pending');
          } else {
            div.classList.add('available');
          }
        }
      }

      const socket = new SockJS('http://localhost:8080/ws/seats');
      const stompClient = Stomp.over(socket);

      stompClient.connect({}, function () {
        console.log('WebSocket 연결됨');
        stompClient.subscribe('/topic/seats/update', function (message) {
          const seat = JSON.parse(message.body);
          updateSeat(seat);
        });
      });

      function selectSeat(seatId) {
        const seat = seatMap.get(seatId);

        if (seat.status === 'RESERVED') {
          showInfoModal('이미 예약된 좌석입니다.');
          return;
        }

        if (seat.status === 'PENDING') {
          showInfoModal('예약 중인 좌석입니다.');
          return;
        }

        // AVAILABLE 좌석인 경우 예약 진행
        fetch('http://localhost:8080/reservation/pending', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            seatId: seatId,
            userId: 123,
            status: 'PENDING',
          }),
        }).then(() => {
          selectedSeatId = seatId;
          showModal();
        });
      }

      function showModal() {
        document.getElementById('modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
        countdown = 20;
        confirmed = false;
        modalHandled = false;
        updateTimer();
        countdownInterval = setInterval(() => {
          countdown--;
          updateTimer();
          if (countdown <= 0) {
            closeModal();
          }
        }, 1000);
      }

      function showInfoModal(message) {
        document.getElementById('info-modal-text').innerText = message;
        document.getElementById('info-modal').style.display = 'block';
        document.getElementById('info-modal-overlay').style.display = 'block';
      }

      function closeInfoModal() {
        document.getElementById('info-modal').style.display = 'none';
        document.getElementById('info-modal-overlay').style.display = 'none';
      }

      function updateTimer() {
        document.getElementById('timer').innerText = countdown;
      }

      function closeModal() {
        if (modalHandled) return;
        modalHandled = true;

        document.getElementById('modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        clearInterval(countdownInterval);

        // 예약 확정된 경우에는 상태 되돌리지 않음
        if (confirmed) return;

        if (selectedSeatId) {
          fetch('http://localhost:8080/reservation/update', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              seatId: selectedSeatId,
              userId: 123,
              status: 'AVAILABLE',
            }),
          }).then(() => {
            const seat = seatMap.get(selectedSeatId);
            if (seat) {
              seat.status = 'AVAILABLE';
              updateSeat(seat);
            }
            selectedSeatId = null;
          });
        }
      }

      function confirmReservation() {
        confirmed = true;
        clearInterval(countdownInterval);
        document.getElementById('modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';

        if (selectedSeatId) {
          fetch('http://localhost:8080/reservation/reserve', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              seatId: selectedSeatId,
              status: 'RESERVED',
              userId: 123,
            }),
          }).then(() => {
            const seat = seatMap.get(selectedSeatId);
            if (seat) {
              seat.status = 'RESERVED';
              updateSeat(seat);
            }
            selectedSeatId = null;
          });
        }
      }
    </script>
  </body>
</html>
